<!--
Force Graph SVG Visualization

Structure:
1. Defs section for gradients and markers
2. Links layer (rendered first, so nodes appear on top)
3. Nodes layer with circles and labels

Why SVG?
- Vector graphics scale at any zoom level
- Native DOM events for drag/click
- CSS styling for appearance
- Accessibility: screen readers can parse text
-->

<div class="force-graph-container">
  <!-- Loading state -->
  @if (loading) {
    <div class="loading-overlay">
      <div class="loading-spinner"></div>
      <span>Loading graph...</span>
    </div>
  }

  <!-- Error state -->
  @if (error && !loading) {
    <div class="error-message">
      <span class="error-icon">âš </span>
      <span>{{ error }}</span>
      <button (click)="loadGraphData()">Retry</button>
    </div>
  }

  <!-- Empty state -->
  @if (!loading && !error && nodes.length === 0) {
    <div class="empty-state">
      <span class="empty-icon">ðŸ“Š</span>
      <span>Select a deliverer to view their graph</span>
    </div>
  }

  <!-- SVG Graph -->
  @if (!loading && !error && nodes.length > 0) {
    <svg
      #svgElement
      [attr.viewBox]="viewBox"
      [attr.width]="width"
      [attr.height]="height"
      class="force-graph-svg"
      preserveAspectRatio="xMidYMid meet"
      >
      <!-- Definitions: gradients, markers -->
      <defs>
        <!-- Arrow marker for directed edges -->
        <marker
          id="arrowhead"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
          markerUnits="strokeWidth"
          >
          <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
        </marker>
        <!-- Glow filter for selected nodes -->
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <!-- Drop shadow for nodes -->
        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.3"/>
        </filter>
      </defs>
      <!-- Links layer -->
      <g class="links-layer">
        @for (link of links; track link) {
          <line
            [attr.x1]="getNode(link.source)?.x"
            [attr.y1]="getNode(link.source)?.y"
            [attr.x2]="getNode(link.target)?.x"
            [attr.y2]="getNode(link.target)?.y"
            [attr.class]="getLinkClass(link)"
            [attr.stroke-width]="link.strength * 2"
            />
        }
      </g>
      <!-- Nodes layer -->
      <g class="nodes-layer">
        @for (node of nodes; track node) {
          <g
            [attr.transform]="'translate(' + node.x + ',' + node.y + ')'"
            [attr.class]="getNodeClass(node)"
            (mousedown)="onNodeMouseDown($event, node)"
            (click)="onNodeClick($event, node)"
            (dblclick)="onNodeDblClick($event, node)"
            style="cursor: grab"
            >
            <!-- Node circle -->
            <circle
              [attr.r]="node.radius"
              [attr.fill]="getNodeColor(node)"
              filter="url(#shadow)"
              />
            <!-- Node border (for emphasis) -->
            @if (node.nodeType === 'deliverer') {
              <circle
                [attr.r]="node.radius + 2"
                fill="none"
                stroke="#fff"
                stroke-width="3"
                />
            }
            <!-- Node icon/indicator based on type -->
            @if (node.nodeType === 'deliverer') {
              <text
                text-anchor="middle"
                dominant-baseline="central"
                fill="white"
                font-size="20"
              >ðŸš´</text>
            }
            @if (node.nodeType === 'delivery') {
              <text
                text-anchor="middle"
                dominant-baseline="central"
                fill="white"
                font-size="14"
              >ðŸ“¦</text>
            }
            @if (node.nodeType === 'issue') {
              <text
                text-anchor="middle"
                dominant-baseline="central"
                fill="white"
                font-size="12"
              >{{ node.data.resolved ? 'âœ“' : '!' }}</text>
            }
            <!-- Node label (below the circle) -->
            <text
              [attr.y]="node.radius + 14"
              text-anchor="middle"
              class="node-label"
              fill="#333"
              font-size="11"
            >{{ node.label }}</text>
            <!-- Tooltip (title element for native browser tooltip) -->
            <title>{{ getTooltip(node) }}</title>
          </g>
        }
      </g>
    </svg>
  }

  <!-- Legend -->
  @if (nodes.length > 0) {
    <div class="legend">
      <div class="legend-title">Legend</div>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-dot deliverer"></span>
          <span>Deliverer</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot delivery-completed"></span>
          <span>Completed</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot delivery-ongoing"></span>
          <span>Ongoing</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot delivery-upcoming"></span>
          <span>Upcoming</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot issue"></span>
          <span>Issue</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot issue-resolved"></span>
          <span>Resolved</span>
        </div>
      </div>
    </div>
  }
</div>
