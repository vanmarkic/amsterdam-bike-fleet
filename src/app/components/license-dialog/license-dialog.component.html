<!-- Modal backdrop (only shown when isModal is true and isOpen is true) -->
@if (isModal && isOpen) {
  <div
    class="modal-backdrop"
    (click)="onBackdropClick($event)"
    (keydown)="onKeyDown($event)"
    tabindex="0"
    role="dialog"
    aria-modal="true"
    aria-labelledby="license-dialog-title">
    <div class="dialog-container" role="document">
      <!-- Close button -->
      <button
        class="close-button"
        (click)="closeModal()"
        aria-label="Close dialog"
        type="button">
        &times;
      </button>
      <ng-container *ngTemplateOutlet="dialogContent"></ng-container>
    </div>
  </div>
}

<!-- Standalone page content (when isModal is false) -->
@if (!isModal) {
  <div class="standalone-container">
    <ng-container *ngTemplateOutlet="dialogContent"></ng-container>
  </div>
}

<!-- Shared dialog content template -->
<ng-template #dialogContent>
  <div class="license-dialog">
    <h2 id="license-dialog-title" class="dialog-title">License Management</h2>

    <!-- Browser mode warning -->
    @if (!isTauriEnvironment) {
      <div class="warning-banner">
        <span class="warning-icon">!</span>
        <span>Running in browser mode. License features require the desktop app.</span>
      </div>
    }

    <!-- Current License Status Section -->
    <section class="section license-status-section">
      <h3 class="section-title">Current License Status</h3>

      <div class="status-header">
        <span class="status-badge" [ngClass]="getStatusBadgeClass()">
          {{ getStatusText() }}
        </span>
        <button
          class="refresh-button"
          (click)="refreshStatus()"
          [disabled]="loading"
          type="button"
          aria-label="Refresh license status">
          <span [class.spinning]="loading">&#8635;</span>
        </button>
      </div>

      <!-- License Info (when licensed) -->
      @if (licenseInfo) {
        <div class="license-info">
          <div class="info-row">
            <span class="info-label">Customer:</span>
            <span class="info-value">{{ licenseInfo.customer }}</span>
          </div>
          @if (licenseInfo.company) {
            <div class="info-row">
              <span class="info-label">Company:</span>
              <span class="info-value">{{ licenseInfo.company }}</span>
            </div>
          }
          <div class="info-row">
            <span class="info-label">Product:</span>
            <span class="info-value">{{ licenseInfo.product }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Expires:</span>
            <span class="info-value" [class.expiring-soon]="isExpiringSoon" [class.expired]="isExpired">
              {{ formatDate(licenseInfo.expires) }}
              @if (daysRemaining !== null) {
                <span class="days-remaining">
                  ({{ daysRemaining > 0 ? daysRemaining + ' days left' : 'Expired' }})
                </span>
              }
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Features:</span>
            <span class="info-value features">{{ formatFeatures(licenseInfo.features) }}</span>
          </div>
          @if (licenseInfo.seats) {
            <div class="info-row">
              <span class="info-label">Seats:</span>
              <span class="info-value">{{ licenseInfo.seats }}</span>
            </div>
          }
          @if (licenseInfo.issued) {
            <div class="info-row">
              <span class="info-label">Issued:</span>
              <span class="info-value">{{ formatDate(licenseInfo.issued) }}</span>
            </div>
          }
        </div>
      }

      <!-- No License Message -->
      @if (!licenseInfo && !loading) {
        <div class="no-license-message">
          <p>No active license found. Enter a license key below to activate.</p>
        </div>
      }
    </section>

    <!-- License Activation Section -->
    <section class="section activation-section">
      <h3 class="section-title">{{ isLicensed ? 'Update License' : 'Activate License' }}</h3>

      <div class="input-group">
        <label for="license-key-input" class="input-label">License Key</label>
        <input
          id="license-key-input"
          type="text"
          class="license-input"
          [(ngModel)]="licenseKey"
          placeholder="Enter your license key"
          [disabled]="loading || isValidating || !isTauriEnvironment"
          (input)="clearMessages()"
          autocomplete="off"
          spellcheck="false" />
      </div>

      <!-- Validation Preview -->
      @if (validationResult) {
        <div class="validation-preview">
          <h4 class="preview-title">License Preview</h4>
          @if (validationResult.valid) {
            <div class="preview-valid">
              <div class="info-row">
                <span class="info-label">Customer:</span>
                <span class="info-value">{{ validationResult.info?.customer }}</span>
              </div>
              @if (validationResult.info?.company) {
                <div class="info-row">
                  <span class="info-label">Company:</span>
                  <span class="info-value">{{ validationResult.info?.company }}</span>
                </div>
              }
              <div class="info-row">
                <span class="info-label">Expires:</span>
                <span class="info-value">{{ formatDate(validationResult.info?.expires) }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Features:</span>
                <span class="info-value">{{ formatFeatures(validationResult.info?.features || []) }}</span>
              </div>
            </div>
          }
          @if (!validationResult.valid) {
            <div class="preview-invalid">
              <span class="error-icon">&#10006;</span>
              <span>{{ validationResult.error || 'Invalid license key' }}</span>
            </div>
          }
        </div>
      }

      <!-- Action Buttons -->
      <div class="button-group">
        <button
          class="btn btn-secondary"
          (click)="validateKey()"
          [disabled]="!licenseKey.trim() || loading || isValidating || !isTauriEnvironment"
          type="button">
          @if (isValidating) {
            <span class="btn-spinner"></span>
          }
          {{ isValidating ? 'Validating...' : 'Validate' }}
        </button>

        <button
          class="btn btn-primary"
          (click)="activateLicense()"
          [disabled]="!canActivate || !isTauriEnvironment"
          type="button">
          @if (loading && !isValidating) {
            <span class="btn-spinner"></span>
          }
          {{ loading && !isValidating ? 'Activating...' : 'Activate' }}
        </button>
      </div>
    </section>

    <!-- Deactivation Section (only when licensed) -->
    @if (isLicensed) {
      <section class="section deactivation-section">
        <h3 class="section-title">Deactivate License</h3>
        <p class="deactivation-warning">
          Deactivating will remove the current license from this device.
          Premium features will no longer be available.
        </p>
        <button
          class="btn btn-danger"
          (click)="deactivateLicense()"
          [disabled]="!canDeactivate"
          type="button">
          {{ loading ? 'Deactivating...' : 'Deactivate License' }}
        </button>
      </section>
    }

    <!-- Messages -->
    <div class="messages">
      <!-- Error Message -->
      @if (error) {
        <div class="message message-error" role="alert">
          <span class="message-icon">&#10006;</span>
          <span>{{ error }}</span>
        </div>
      }

      <!-- Success Messages -->
      @if (activationSuccess) {
        <div class="message message-success" role="status">
          <span class="message-icon">&#10004;</span>
          <span>License activated successfully!</span>
        </div>
      }

      @if (deactivationSuccess) {
        <div class="message message-success" role="status">
          <span class="message-icon">&#10004;</span>
          <span>License deactivated successfully.</span>
        </div>
      }
    </div>
  </div>
</ng-template>
